{% extends '::base.html.twig' %}
{% block body %}
    <div class="container">
        <div class="row">
            <h1 class="text-center">Envoi de devis</h1>
            <h3 class="text-center"><small>Vous pouvez déposer votre pdf n'importe ou sur la page pour l'ajouter au devis</small></h3>
        </div>
        <div class="text-center alert" style="display:none;">
        </div>
        <div class="row">
            <div class="col-md-6 col-md-offset-3">
                <form method="POST" action="{{ path('send_viewer') }}">
                    <div class="form-group">
                        <label class="text-center" for="ref-patient">Référence patient</label>
                        <input class="form-control" id="ref-patient" name="ref-patient"/>
                    </div>
                    <div class="form-group">
                        <label class="text-center" for="nom-patient">Nom patient</label>
                        <input class="form-control" id="nom-patient" name="nom-patient"/>
                    </div>
                    <div id="actions" class="row">
                        <div class="col-lg-7" style="padding-left:0px;">
                            <!-- The fileinput-button span is used to style the file input field as button -->
							<span class="btn btn-success fileinput-button">
								<i class="glyphicon glyphicon-plus"></i>
								<span>Ajouter un devis (PDF)</span>
							</span>
                        </div>

                        <div class="col-lg-5">
                            <!-- The global file processing state -->
							<span class="fileupload-process">
								<div id="total-progress" class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                                    <div class="progress-bar progress-bar-success" style="width:0%;" data-dz-uploadprogress></div>
                                </div>
							</span>
                        </div>
                    </div>

                    <div class="table table-striped files" id="previews">
                        <div id="template" class="file-row">
                            <!-- This is used as the file preview template -->
                            <div>
                                <span class="preview"><img data-dz-thumbnail /></span>
                            </div>
                            <div>
                                <p class="name" data-dz-name></p>
                                <strong class="error text-danger" data-dz-errormessage></strong>
                            </div>
                            <div>
                                <p class="size" data-dz-size></p>
                                <div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                                    <div class="progress-bar progress-bar-success" style="width:0%;" data-dz-uploadprogress></div>
                                </div>
                            </div>
                            <div>
                                <button data-dz-remove class="btn btn-warning cancel">
                                    <i class="glyphicon glyphicon-ban-circle"></i>
                                    <span>Annuler</span>
                                </button>
                                <button data-dz-remove class="btn btn-danger delete">
                                    <i class="glyphicon glyphicon-trash"></i>
                                    <span>Supprimer</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <input class="btn center-block btn-default" type="submit">
                </form>
            </div>
        </div>
    </div>
{% endblock %}
{% block javascript %}
    <script type="text/javascript" src="{{ asset('bundles/viewer/js/dropzone.js')}}"></script>
    <script>
        $( document ).ready(function() {
            // Get the template HTML and remove it from the doumenthe template HTML and remove it from the doument
            var previewNode = document.querySelector("#template");
            previewNode.id = "";
            var previewTemplate = previewNode.parentNode.innerHTML;
            previewNode.parentNode.removeChild(previewNode);
            var myDropzone = new Dropzone(document.body, { // Make the whole body a dropzone
                url: "{{ oneup_uploader_endpoint('documents') }}", // Set the url
                thumbnailWidth: 80,
                maxFiles: 2,
                thumbnailHeight: 80,
                parallelUploads: 20,
                previewTemplate: previewTemplate,
                previewsContainer: "#previews", // Define the container to display the previews
                clickable: ".fileinput-button", // Define the element that should be used as click trigger to select files.
                dictMaxFilesExceeded: 'Maximum 2 fichiers',
            });
            // Update the total progress bar
            myDropzone.on("totaluploadprogress", function(progress) {
                document.querySelector("#total-progress .progress-bar").style.width = progress + "%";
            });
            myDropzone.on("sending", function(file) {
                // Show the total progress bar when upload starts
                document.querySelector("#total-progress").style.opacity = "1";
            });
            // Hide the total progress bar when nothing's uploading anymore
            myDropzone.on("queuecomplete", function(progress) {
                document.querySelector("#total-progress").style.opacity = "0";
            });

            myDropzone.on('success', function(file, response) {
                $('.alert').addClass('alert-success');
                $('.alert').text('Le fichier '+file.name+' a ajouté avec succès');
                $('.alert').show();
            });
            myDropzone.on('canceled', function(file, response) {
                $('.alert').addClass('alert-warning');
                $('.alert').text('L\'envoi du fichier '+file.name+' a été annulé');
                $('.alert').show();
            });
        });
    </script>
{% endblock %}

{% block stylesheets %}
    <style>
        html, body {
            height: 100%;
        }
        #actions {
            margin: 2em 0;
        }
        /* Mimic table appearance */
        div.table {
            display: table;
        }
        div.table .file-row {
            display: table-row;
        }
        div.table .file-row > div {
            display: table-cell;
            vertical-align: top;
            border-top: 1px solid #ddd;
            padding: 8px;
        }
        div.table .file-row:nth-child(odd) {
            background: #f9f9f9;
        }
        /* The total progress gets shown by event listeners */
        #total-progress {
            opacity: 0;
            transition: opacity 0.3s linear;
        }
        /* Hide the progress bar when finished */
        #previews .file-row.dz-success .progress {
            opacity: 0;
            transition: opacity 0.3s linear;
        }
        /* Hide the delete button initially */
        #previews .file-row .delete {
            display: none;
        }
        /* Hide the start and cancel buttons and show the delete button */
        #previews .file-row.dz-success .start,
        #previews .file-row.dz-success .cancel {
            display: none;
        }
        #previews .file-row.dz-success .delete {
            display: block;
        }
    </style>
{% endblock %}